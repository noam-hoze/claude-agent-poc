name: Claude Agent

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited]
  pull_request_review_comment:
    types: [created, edited]

jobs:
  claude-response:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') || contains(github.event.issue.body, '@claude') || contains(github.event.pull_request.body, '@claude')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Call Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the context
          if [ "${{ github.event_name }}" == "issue_comment" ] || [ "${{ github.event_name }}" == "issues" ]; then
            ISSUE_NUMBER=${{ github.event.issue.number }}
            COMMENT_BODY="${{ github.event.comment.body || github.event.issue.body }}"
          else
            ISSUE_NUMBER=${{ github.event.pull_request.number }}
            COMMENT_BODY="${{ github.event.comment.body || github.event.pull_request.body }}"
          fi
          
          # Read CLAUDE.md for context
          CONTEXT=$(cat CLAUDE.md 2>/dev/null || echo "No project context available")
          
          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": \"Project Context:\\n$CONTEXT\\n\\nUser Query:\\n$COMMENT_BODY\"
              }]
            }")
          
          # Extract response text
          CLAUDE_RESPONSE=$(echo $RESPONSE | jq -r '.content[0].text')
          
          # Post comment back to GitHub
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
            -d "{\"body\":\"$CLAUDE_RESPONSE\"}"
