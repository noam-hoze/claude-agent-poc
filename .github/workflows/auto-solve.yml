# Claude Code Workflow
#
# This workflow integrates Claude AI into GitHub to automatically handle issues and PRs.
#
# Two main features:
# 1. Interactive Mode: Responds to @claude mentions in issues, PRs, and comments
# 2. Auto-solve Mode: Implements issues with human approval at each phase
#
# Prerequisites:
# - ANTHROPIC_API_KEY secret must be configured in repository settings
# - "Allow GitHub Actions to create and approve pull requests" must be enabled
#   (Settings > Actions > General > Workflow permissions)

name: Claude Code

on:
  # Triggers for interactive @claude mentions and /approve commands
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  # Triggers for auto-solve and issue assignments
  issues:
    types: [opened, assigned, labeled]

# Required permissions for Claude to interact with the repository
permissions:
  contents: write       # Create branches, commits, and push changes
  pull-requests: write  # Create and update pull requests
  issues: write         # Comment on issues and update labels
  id-token: write       # Authentication with external services
  actions: read         # Read CI/CD workflow results

# Prevent concurrent runs on the same issue/PR to avoid conflicts
concurrency:
  group: claude-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # INTERACTIVE MODE: Responds to @claude mentions
  # ============================================================================
  claude-interactive:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude-bot')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --max-turns 10
            --model claude-opus-4-5-20251101
          track_progress: true
          use_sticky_comment: true
          branch_prefix: "claude/"
          base_branch: "main"

  # ============================================================================
  # AUTO-SOLVE MODE: Phased implementation with human approval
  # ============================================================================
  # Phases:
  # 1. PLANNING - Claude analyzes and proposes a plan (no code)
  # 2. CODING - Claude implements after plan approval
  # 3. TESTING - Claude validates after code approval
  # 4. PR - Creates PR after testing approval
  #
  # Commands:
  # - /approve : Approve current phase and proceed to next
  # - Any other comment: Feedback for Claude to revise current phase
  auto-solve-phased:
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'auto-solve') ||
      (github.event_name == 'issue_comment' && contains(join(github.event.issue.labels.*.name, ','), 'auto-solve') && !contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Determine current phase and action
        id: phase
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
        run: |
          # Get current labels
          LABELS=$(gh issue view $ISSUE_NUMBER --json labels --jq '.labels[].name' | tr '\n' ',')
          echo "Current labels: $LABELS"

          # Determine current phase from labels
          if [[ "$LABELS" == *"phase:testing"* ]]; then
            CURRENT_PHASE="testing"
          elif [[ "$LABELS" == *"phase:coding"* ]]; then
            CURRENT_PHASE="coding"
          elif [[ "$LABELS" == *"phase:planning"* ]]; then
            CURRENT_PHASE="planning"
          else
            CURRENT_PHASE="none"
          fi
          echo "Current phase: $CURRENT_PHASE"

          # Determine action based on event
          if [[ "$EVENT_NAME" == "issues" && "$EVENT_ACTION" == "labeled" ]]; then
            # Fresh start - begin planning
            ACTION="start"
            NEXT_PHASE="planning"
          elif [[ "$COMMENT_BODY" == "/approve"* ]]; then
            # Approval - advance to next phase
            ACTION="advance"
            case "$CURRENT_PHASE" in
              "planning") NEXT_PHASE="coding" ;;
              "coding") NEXT_PHASE="testing" ;;
              "testing") NEXT_PHASE="pr" ;;
              *) NEXT_PHASE="planning" ;;
            esac
          else
            # Feedback - revise current phase
            ACTION="revise"
            NEXT_PHASE="$CURRENT_PHASE"
          fi

          echo "Action: $ACTION"
          echo "Next phase: $NEXT_PHASE"

          echo "current_phase=$CURRENT_PHASE" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "next_phase=$NEXT_PHASE" >> $GITHUB_OUTPUT

      - name: Update phase label
        if: steps.phase.outputs.action != 'revise'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CURRENT_PHASE: ${{ steps.phase.outputs.current_phase }}
          NEXT_PHASE: ${{ steps.phase.outputs.next_phase }}
        run: |
          # Remove current phase label if exists
          if [[ "$CURRENT_PHASE" != "none" ]]; then
            gh issue edit $ISSUE_NUMBER --remove-label "phase:$CURRENT_PHASE" || true
          fi

          # Add next phase label (unless it's PR phase)
          if [[ "$NEXT_PHASE" != "pr" ]]; then
            gh issue edit $ISSUE_NUMBER --add-label "phase:$NEXT_PHASE" || true
          fi

      # =========== PLANNING PHASE ===========
      - name: Run Claude - Planning Phase
        if: steps.phase.outputs.next_phase == 'planning'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Analyze issue #${{ github.event.issue.number }} and create a detailed implementation plan.

            ‚ö†Ô∏è IMPORTANT: DO NOT write any code yet. This is the PLANNING phase only.

            Create a plan that includes:
            1. **Summary**: Brief description of what needs to be done
            2. **Files to modify/create**: List each file with what changes are needed
            3. **Approach**: Step-by-step implementation approach
            4. **Considerations**: Any edge cases, potential issues, or questions

            Format your response clearly with headers.

            End your response with:
            ---
            ‚úÖ **Plan complete.** Reply with `/approve` to proceed to implementation, or provide feedback to revise the plan.
          claude_args: |
            --max-turns 5
            --model claude-sonnet-4-5-20250929
          track_progress: true
          use_sticky_comment: true

      # =========== CODING PHASE ===========
      - name: Run Claude - Coding Phase
        if: steps.phase.outputs.next_phase == 'coding'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Implement the approved plan for issue #${{ github.event.issue.number }}.

            Read the previous comments to understand the approved plan, then:
            1. Write the code as specified in the plan
            2. Commit your changes with clear commit messages
            3. Push to the current branch

            ‚ö†Ô∏è DO NOT create a PR yet. That happens after testing approval.

            After implementing, provide a summary of:
            - Files created/modified
            - Key changes made
            - Any deviations from the plan (and why)

            End your response with:
            ---
            ‚úÖ **Implementation complete.** Reply with `/approve` to proceed to testing, or provide feedback to revise the code.
          claude_args: |
            --max-turns 30
            --model claude-sonnet-4-5-20250929
          track_progress: true
          use_sticky_comment: true
          branch_prefix: "claude/"
          base_branch: "main"
          allowed_tools: |
            Bash(chmod:*)
            Bash(npm:*)
            Bash(git:*)

      # =========== TESTING PHASE ===========
      - name: Run Claude - Testing Phase
        if: steps.phase.outputs.next_phase == 'testing'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Validate the implementation for issue #${{ github.event.issue.number }}.

            1. Review the code changes made in previous phase
            2. Run any existing tests if available
            3. Verify the implementation matches the requirements
            4. Check for obvious issues or bugs

            Provide a testing report:
            - What was tested
            - Results (pass/fail)
            - Any issues found
            - Recommendations

            End your response with:
            ---
            ‚úÖ **Testing complete.** Reply with `/approve` to create the PR, or provide feedback to revise.
          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-5-20250929
          track_progress: true
          use_sticky_comment: true
          allowed_tools: |
            Bash(npm:*)
            Bash(pytest:*)
            Bash(git:*)

      # =========== PR CREATION PHASE ===========
      - name: Create PR
        if: steps.phase.outputs.next_phase == 'pr'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get current branch
          BRANCH=$(git branch --show-current)
          echo "Current branch: $BRANCH"

          if [[ $BRANCH == claude/* ]]; then
            # Check if PR already exists
            EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')

            if [ -z "$EXISTING_PR" ]; then
              # Get issue title for PR
              ISSUE_TITLE=$(gh issue view $ISSUE_NUMBER --json title --jq '.title')

              PR_BODY=$(cat <<EOF
          Resolves #$ISSUE_NUMBER

          This PR was created through the phased auto-solve workflow with human approval at each step.

          ## Phases Completed
          - ‚úÖ Planning - Approved
          - ‚úÖ Implementation - Approved
          - ‚úÖ Testing - Approved

          ## Changes
          $(git log main..HEAD --pretty=format:'- %s')

          ---
          ü§ñ Generated with [Claude Code](https://claude.ai/code)
          EOF
              )

              gh pr create \
                --base main \
                --head "$BRANCH" \
                --title "Implement: $ISSUE_TITLE" \
                --body "$PR_BODY"

              # Update issue with completion
              gh issue edit $ISSUE_NUMBER --remove-label "phase:testing" || true
              gh issue edit $ISSUE_NUMBER --add-label "phase:complete"
              gh issue comment $ISSUE_NUMBER --body "‚úÖ **PR created!** All phases complete. The implementation is ready for final review."
            else
              echo "PR #$EXISTING_PR already exists"
            fi
          else
            echo "Not on a claude/* branch, cannot create PR"
          fi

      # =========== REVISION (Feedback handling) ===========
      - name: Run Claude - Revision
        if: steps.phase.outputs.action == 'revise' && steps.phase.outputs.current_phase != 'none'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            The user has provided feedback on the current phase (${{ steps.phase.outputs.current_phase }}) for issue #${{ github.event.issue.number }}.

            Their feedback: "${{ github.event.comment.body }}"

            Please revise your work based on this feedback.

            After revision, end your response with:
            ---
            ‚úÖ **Revision complete.** Reply with `/approve` to proceed, or provide more feedback.
          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-5-20250929
          track_progress: true
          use_sticky_comment: true
          allowed_tools: |
            Bash(chmod:*)
            Bash(npm:*)
            Bash(git:*)
